include::attributes.adoc[]

= Codexium Magnus System Architecture Specification
:revnumber: 1.2
:revdate: 2025-11-11
:status: Draft

== 1. Introduction

=== 1.1 Purpose

This document defines the *system-level architecture* for *Codexium Magnus (CM)*, a cross-platform, GPL-3 desktop application for viewing, searching, and managing digitally signed content cartridges. This version (v1.2) updates the architecture for Qt 6 migration, replacing Avalonia/CEF with Qt Widgets/WebEngine.

=== 1.2 Scope

This specification applies to:

* The *Viewer* (Qt Widgets + Qt WebEngine) desktop application
* The optional *Authoring Tool* (Qt Widgets + Qt WebEngine in author mode)
* The *Build/CLI toolchain* for cartridge construction and signing
* The *Cartridge format* (SQLite-based, read-only, signed)
* The *Key management* and *signature verification* pipeline

Online services and publishing registries remain out of scope for v1.x.

=== 1.3 Audience

* Architects and senior developers designing CM subsystems
* Contributors implementing Viewer/Authoring/CLI features
* Publishers/toolsmiths integrating CM cartridge builders
* Auditors reviewing trust and liability separation

=== 1.4 References

* Codexium Magnus Requirements Specification v1.3
* Qt 6 Framework Documentation
* Qt WebEngine Documentation
* SQLite 3 FTS5 Documentation
* GNU GPL-3 License
* Ed25519 Signature Scheme

== 2. Architectural Overview

=== 2.1 Architectural Style

Codexium Magnus uses a *layered, component-based architecture*:

1. *Presentation Layer* — Qt Widgets UI, windowing, panels.
2. *Integration Layer* — Qt WebEngine host (HTML renderer), link/print bridges.
3. *Application Layer* — view models, navigation, theming, search orchestration.
4. *Domain Layer* — cartridge reader, schema adapters, signing/trust.
5. *Infrastructure Layer* — SQLite, file I/O, key store, logging.

The guiding principle is *stable core, pluggable content*: viewer code changes infrequently; cartridges supply dynamic data.

=== 2.2 High-Level Component Model

* *Viewer Shell (Qt Widgets)*
  * windowing
  * navigation / search panes
  * preference persistence

* *Rendering Host (Qt WebEngine)*
  * HTML fragment rendering
  * token-based theming injection
  * *link interception → ILinkService*
  * *print invocation → IPrintService*

* *Content Subsystem*
  * cartridge opener (SQLite via Qt SQL)
  * manifest reader (JSON via Qt JSON)
  * document/section provider
  * asset resolver

* *Search Subsystem*
  * SQLite FTS5 adapter (via Qt SQL)
  * Boolean / wildcard / fuzzy query builder
  * result shaping

* *Security / Signing Subsystem*
  * Ed25519 verify (C++ library, e.g., libsodium)
  * trust classification
  * user-managed key store

* *Theme Management Subsystem*
  * ThemeManager service
  * token-based stylesheet system
  * light/sepia/dark default themes
  * custom theme support

* *Authoring Subsystem (optional)*
  * Qt WebEngine WYSIWYG
  * metadata/frontmatter editor
  * spec validator
  * previewer using same Qt WebEngine pipeline

* *Build / CLI Subsystem*
  * source ingestion
  * normalization
  * SQLite cartridge writer
  * manifest/signature generator

== 3. Deployment View

=== 3.1 Target Platforms

* *Windows 10+*: C++17/20, Qt 6 (static), CMake
* *macOS 13+*: C++17/20, Qt 6 (static), CMake
* *Linux (GTK-compatible)*: C++17/20, Qt 6 (static), CMake

=== 3.2 Deployment Units

* `codexium-magnus-viewer` (static executable)
* `codexium-magnus-author` (optional or build flag, static executable)
* `codexium-magnus-cli` (static executable)
* `*.ruleset` cartridges (SQLite, read-only)

=== 3.3 External Dependencies

* OS default browser / URL handler (for external links, via QDesktopServices)
* OS print dialog / print subsystem (for printing, via QPrintDialog)

== 4. Component Descriptions

=== 4.1 Viewer Shell

**Responsibilities**

* Launch and host Qt Widgets UI
* Manage panes and document view lifetime
* Maintain user preferences (theme, font size, zoom)
* Expose commands: OpenCartridge, Search, Print, OpenExternal

**Interfaces**

* Consumes: `ICartridgeService`, `ISearchService`, `IThemeService`, `ILinkService`, `IPrintService`
* Publishes: UI events → ViewModels

**Notes**

* Must remain ignorant of cartridge internal schema beyond service contracts.
* Uses Qt Fusion style as base with custom stylesheets for modern appearance.

=== 4.2 Rendering Host (Qt WebEngine)

**Responsibilities**

* Render normalized HTML fragments
* Inject global CSS token definitions
* Provide in-page navigation
* *Intercept all link activations* and forward to `ILinkService`
* *Handle print requests* (user-triggered or content-triggered) by forwarding to `IPrintService`

**Interfaces**

* To Viewer Shell: signals `linkActivated(QUrl)`, `printRequested(DocumentContext)`
* From Viewer Shell: slots `loadHtml(QString, QUrl)`, `applyTokens(QMap<QString, QString>)`

**Security**

* Default: scripts disabled
* If `data-interactive="true"`: enable sandboxed script context, still with link/print interception

**Implementation**

* Uses `QWebEngineView` for rendering
* `QWebChannel` for C++ ↔ JavaScript communication
* `QWebEnginePage::acceptNavigationRequest` for link interception

=== 4.3 Content Subsystem

**Responsibilities**

* Open `.ruleset` SQLite files (via Qt SQL)
* Verify structure and minimal schema
* Read manifest (corpus, volumes, titles, signature metadata)
* Provide documents and sections to application
* Provide asset streams to Qt WebEngine (via custom URI scheme handler)

**Data Flow**

1. Viewer calls `OpenCartridge(path)`.
2. Content Subsystem validates and returns handle.
3. Viewer asks for `GetDocument(docId)` → HTML fragment + metadata.
4. Qt WebEngine loads fragment.
5. Asset requests are routed back via custom URI scheme handler (`QWebEngineUrlSchemeHandler`).

=== 4.4 Search Subsystem

**Responsibilities**

* Build FTS queries against cartridge DB (via Qt SQL)
* Support Boolean, wildcard, fuzzy, case-sensitive
* Return ranked results with document + section info

**Integration**

* Search pane in Viewer → Search Service → Content DB
* Results used to drive document navigation

=== 4.5 Security / Signing Subsystem

**Responsibilities**

* Ed25519 verification over manifest + DB hash (via C++ library, e.g., libsodium)
* User-importable public keys
* Trust classification:
  * Official
  * Verified
  * Unverified/Homebrew

**Integration**

* Viewer displays trust badge
* Rendering Host checks trust level before enabling interactive features
* *Link/print services MAY consult trust level* to warn/gate actions

=== 4.6 Theme Management Subsystem

**Responsibilities**

* Manage theme switching (light/sepia/dark/custom)
* Load and apply stylesheets (token-based)
* Persist theme preferences (via QSettings)
* Synchronize theme tokens with Qt WebEngine content CSS

**Interfaces**

* `IThemeService` interface
* `ThemeManager` implementation (C++)
* Theme stylesheet files (.qss)

**Integration**

* Viewer Shell applies theme to Qt Widgets
* ThemeManager injects CSS tokens into Qt WebEngine content
* Theme preferences stored via QSettings

=== 4.7 Authoring Subsystem

**Responsibilities**

* Provide non-technical authors with a spec-driven editor
* Run the same normalization rules as CLI
* Preview via same Qt WebEngine config
* NOT sign cartridges

**Integration**

* Shares rendering host, theming service, and validator library with Viewer
* Outputs source files and (optionally) invokes CLI

=== 4.8 Build / CLI Subsystem

**Responsibilities**

* Turn source content into cartridges
* Enforce normalization rules (root wrapper, heading IDs, no `<html>`)
* Build SQLite schema
* Generate manifest JSON
* Sign with Ed25519

**Integration**

* Consumed by publishers
* Developer-friendly for CI

== 5. Cross-Cutting Concerns

=== 5.1 External Link Handling

**Problem:** Inline content may contain external URLs which must not hijack the embedded viewer.

**Architecture Decision**

* All links clicked in Qt WebEngine are *captured*.
* A dedicated *Link Service* decides:
  * *Internal*: `cdoc://...`, `#/anchor` → route back into Viewer/Qt WebEngine
  * *External*: `http://`, `https://`, `mailto:`, OS-registered schemes → dispatch to *OS-level launcher*

**Flow**

1. Qt WebEngine → `acceptNavigationRequest(QUrl, NavigationType, bool)` signal
2. Viewer → `ILinkService.Handle(QUrl, trustContext)`
3. If external:
   * Viewer → platform launcher (`QDesktopServices::openUrl`)
   * Viewer keeps current document loaded
4. If cartridge trust level = Unverified/Homebrew:
   * Viewer MAY show "This content wants to open: {URI}"

**Requirements Supported**

* FR-9, NFR-2

=== 5.2 Printing

**Problem:** Large/complex HTML cannot always be printed reliably directly from the embedded Qt WebEngine window.

**Architecture Decision**

* Introduce a dedicated *Print Service*.
* Support *two* print paths:
+
. *Visible-print path* — for small/medium documents
  * Qt WebEngine prints current view
  * Viewer invokes OS print dialog (`QPrintDialog`)
+
. *Off-screen/print-surface path* — for long/complex documents
  * Create hidden Qt WebEngine view
  * Ask Qt WebEngine to render/`printToPdf`
  * Hand resulting PDF to OS print dialog

**Flow**

1. User selects Print OR content triggers print
2. Viewer → `IPrintService.Print(docContext)`
3. `IPrintService` inspects document size/complexity and platform
4. If small → visible-print (direct Qt WebEngine → OS)
5. If large → off-screen/print-surface (Qt WebEngine → PDF → OS)
6. OS print dialog displayed

**Requirements Supported**

* FR-10, NFR-1, NFR-2

== 6. Data View

=== 6.1 Cartridge Logical Schema

* `Documents(id, slug, title, html, corpus_id, volume_id, category, updated_utc)`
* `Sections(id, doc_id, anchor, title, level, body_text)`
* `DocIndex` (FTS5, over documents/sections)
* `Assets(id, path, mime, blob)`
* `Meta(key, value)`
* `Signature(algorithm, value, public_key_hint)`

=== 6.2 Application Data

* `Preferences(key, value)` (stored via QSettings)
* `TrustedKeys(publisher_id, public_key, added_utc)`
* `RecentDocuments(doc_id, opened_utc)`
* Optional: `PrintHistory(doc_id, printed_utc, pages)`

== 7. Security Architecture

=== 7.1 Threats

* T1: Malicious cartridge tries to navigate user to hostile site.
* T2: Malicious cartridge triggers large-print to crash viewer.
* T3: Modified cartridge attempts to masquerade as official.

=== 7.2 Controls

* Link interception and OS mediation (via QDesktopServices)
* Print mediation and off-screen rendering
* Ed25519 verification
* Trust badge + user prompt on unverified external actions
* No arbitrary network access from content

== 8. Architectural Rationale

1. *Separate link/print services* avoid coupling Qt WebEngine quirks directly to UI logic.
2. *OS mediation* for links reduces liability and keeps the viewer on-task.
3. *Off-screen print* addresses known Qt WebEngine/HTML print inconsistencies.
4. *Self-managed keys* keeps you (the project) out of the SA business.
5. *Qt Fusion + custom stylesheets* provides modern appearance while maintaining cross-platform consistency.

== 9. Change Log (Newest First)

[cols="1,1,1,3"]
|===
|Version |Date |Author |Summary

|1.2-draft
|2025-11-11
|System
|Updated for Qt 6 migration: Replaced Avalonia/CEF with Qt Widgets/WebEngine, updated all component descriptions, added ThemeManager subsystem, updated deployment view for static linking.

|1.1-draft
|2025-11-02
|System
|Added explicit external-link handling (ILinkService) and dual-path printing (IPrintService).

|1.0-draft
|2025-11-02
|System
|Initial architecture baseline for Codexium Magnus.
|===
