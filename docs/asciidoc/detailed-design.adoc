include::attributes.adoc[]

= Codexium Magnus — Detailed Design
:revnumber: 1.2
:revdate: 2025-11-11
:status: Draft

[cols="1,4"]
|===
|*Version:*
|1.2

|*Date:*
|2025-11-11

|*Scope:*
|Qt Widgets host + Qt WebEngine single rendering engine + typography (FR-11) + bibliography (FR-12) + shared reporting + test harnesses + ThemeManager styling system.
|===

== 1. Overview

The detailed design defines the architecture, data models, and component interactions for Codexium Magnus v1.2. It captures the implementation model that follows the system architecture and the high-level design. This version adds support for multi-cartridge libraries via a manifest subsystem and Qt 6 migration.

== 2. System Components

1. *Qt Widgets Shell* – Host application (C++).
2. *Qt WebEngine* – Embedded Chromium rendering engine (single rendering engine).
3. *Core Library* – Configuration resolver, report writer, domain models (typography + bibliography).
4. *Storage Layer* – SQLite3 database with local-first design, idempotent schema creation (via Qt SQL).
5. *Test Harnesses* – Qt Test (Core + Storage) and Playwright/Chrome DevTools Protocol (Qt WebEngine DOM) tests.
6. *Library Manager* – Scans, indexes, and mounts cartridges from the user's library directory.
7. *Manifest Subsystem* – Reads per-cartridge `manifest.json`, persists library metadata, and exposes series/volume groupings to the UI.
8. *ThemeManager* – Manages theme switching, stylesheet loading, and token-based theming system.

== 3. Data Models

=== 3.1 TypographyConfig

[source,cpp]
----
class TypographyConfig {
public:
    QString baseFontFamily;
    double baseFontSizePt = 0.0;
    QList<double> headingScale;
    TypographyPrintOptions printOptions;
};

class TypographyPrintOptions {
public:
    double pageMarginMm = 0.0;
    bool blackOnWhite = false;
};
----

=== 3.2 BibliographyConfig

[source,cpp]
----
class BibliographyConfig {
public:
    QString style;      // e.g. "APA", "CMS"
    QString sortBy;     // e.g. "author", "year"
    QString groupBy;    // e.g. "year"
};
----

=== 3.3 BibliographyEntry

[source,cpp]
----
class BibliographyEntry {
public:
    QString id;
    QString author;
    QString title;
    QString publication;
    QString year;
    QString sourceId;   // link back to cartridge or external source
};
----

=== 3.4 ReportEntry

[source,cpp]
----
enum class ReportSeverity {
    Info = 0,
    Warning = 1,
    Fatal = 2
};

class ReportEntry {
public:
    QDateTime timestampUtc = QDateTime::currentDateTimeUtc();
    ReportSeverity severity;
    QString title;
    QString details;
    QString source;
};
----

== 4. Configuration Resolver (4-Layer)

**Resolution order: System → Corpus → User Profile → Session**

but the merge is performed from lowest → highest so that the highest layer (Session) wins.

* System: built-in defaults (app, platform, theme defaults)
* Corpus: cartridge/corpus-provided settings
* User Profile: persisted user prefs (font size, theme) via QSettings
* Session: temporary, per-run overrides (e.g. print preview)

**Key responsibilities:**

1. Merge typography settings from all participating layers.
2. Merge bibliography settings from all participating layers.
3. Expose an effective config for any view that needs it (Qt Widgets, Qt WebEngine, tests).
4. Keep behavior deterministic and testable.

== 5. Report Writer

A single, shared report writer prevents format sprawl.

**Capabilities**

* Accumulate ReportEntry items at runtime.
* Write Markdown summary to `/reports/YYYY-MM-DD/*.md`.
* Write JSON detail to `/reports/YYYY-MM-DD/*.json` (via QJsonDocument).

All tests and tools emit via this writer for consistent reporting.

== 6. Storage Layer (SQLite3)

The storage layer provides a local, idempotent database for mounted cartridges, bibliography entries, and user settings. Uses Qt SQL for database access.

**Schema (v1):**

[source,sql]
----
CREATE TABLE IF NOT EXISTS Cartridges (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    CartridgeId TEXT NOT NULL,
    Title TEXT NOT NULL,
    SeriesName TEXT,
    VolumeNumber INTEGER,
    Path TEXT NOT NULL,
    Mounted INTEGER NOT NULL DEFAULT 0,
    LastScannedUtc TEXT,
    Version TEXT
);

CREATE TABLE IF NOT EXISTS BibliographyEntries (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    CanonicalKey TEXT,
    Title TEXT,
    Author TEXT,
    Year TEXT,
    SourceId TEXT
);

CREATE TABLE IF NOT EXISTS UserSettings (
    Key TEXT PRIMARY KEY,
    Value TEXT NOT NULL,
    UpdatedUtc TEXT NOT NULL
);
----

Idempotent creation allows safe re-init each startup. Default path: `~/.codexium-magnus/app.db`.

== 7. Host ↔ Qt WebEngine Communication (JSON Contract)

Communication between Qt Widgets host and Qt WebEngine uses JSON messages via `QWebChannel` or `QWebEnginePage::runJavaScript`.

=== 7.1 Envelope

[source,json]
----
{
  "type": "string",
  "requestId": "string?",
  "timestamp": "2025-11-02T19:30:00Z",
  "payload": { }
}
----

=== 7.2 Config Update

[source,json]
----
{
  "type": "config:update",
  "payload": {
    "typography": { "baseFontFamily": "Segoe UI", "baseFontSizePt": 12 },
    "bibliography": { "style": "APA", "sortBy": "author" }
  }
}
----

=== 7.3 TOC (Data)

[source,json]
----
{
  "type": "toc:data",
  "payload": {
    "entries": [
      { "id": "ct-v1-ch1", "title": "Introduction", "volume": "1", "cartridgeId": "ct-vol-1" },
      { "id": "ct-v2-ch1", "title": "Starships", "volume": "2", "cartridgeId": "ct-vol-2" }
    ]
  }
}
----

=== 7.4 Entry Load / Data

[source,json]
----
{ "type": "entry:load", "payload": { "id": "ct-v2-ch1", "cartridgeId": "ct-vol-2" } }

{ "type": "entry:data", "payload": {
  "id": "ct-v2-ch1",
  "title": "Starships",
  "publisher": "GDW",
  "publicationDate": "1980",
  "volume": "2",
  "html": "<h1>Starships</h1><p>…</p>"
} }
----

=== 7.5 Bibliography Data

[source,json]
----
{
  "type": "bibliography:data",
  "payload": {
    "entries": [
      { "id": "bib-001", "author": "Miller, Marc", "title": "Traveller", "year": "1977", "sourceId": "ct-vol-1" }
    ]
  }
}
----

== 8. Test Harnesses

* Core tests: resolver merge logic, bibliography override (Qt Test framework).
* Storage tests: idempotent DB creation (Qt Test framework).
* Playwright/Chrome DevTools Protocol: Qt WebEngine rendering + config application.

All emit via the shared report format.

== 9. Library & Manifest Management

=== 9.1 Goals

Enable multi-cartridge and multi-volume support without breaking existing monolithic cartridges.

=== 9.2 Manifest File

Each cartridge includes a manifest.json at its root:

[source,json]
----
{
  "cartridgeId": "ct-vol-1",
  "title": "Classic Traveller – Volume 1",
  "seriesName": "Classic Traveller Canon",
  "volumeNumber": 1,
  "entryCount": 24,
  "bibliographyCount": 80,
  "version": "1.0.0",
  "description": "Volume 1 of the canonical Traveller materials."
}
----

=== 9.3 LibraryManager Responsibilities

1. Scan library directory for cartridges.
2. Read each manifest and update Cartridges table (via Qt SQL).
3. Group by seriesName + volumeNumber.
4. Expose combined TOC and bibliography to UI.
5. Handle version checks for updates.

=== 9.4 UI Adaptations

* Library pane shows series → volumes → entries.
* Single or multi-cartridge corpora supported.
* Optional "View All Volumes" merged mode.

=== 9.5 Integration Notes

* cartridgeId and volume fields are optional.
* Existing contracts and tests unaffected.
* Manifest metadata stored in SQLite for fast lookup and cross-cartridge search.

== 10. ThemeManager and Styling System

=== 10.1 ThemeManager Class

[source,cpp]
----
class ThemeManager : public QObject {
    Q_OBJECT
public:
    enum Theme { Light, Sepia, Dark, Custom };
    
    ThemeManager(QObject* parent = nullptr);
    
    void setTheme(Theme theme);
    void loadCustomTheme(const QString& themePath);
    void applyStylesheet(const QString& stylesheet);
    QPalette currentPalette() const;
    QMap<QString, QString> getTokenMap() const;
    
signals:
    void themeChanged(Theme theme);
    
private:
    Theme m_currentTheme;
    QString m_customThemePath;
    QMap<QString, QString> m_tokens;
};
----

=== 10.2 Token-Based Theming

**Color Tokens**:

* `--color-background-primary`
* `--color-background-secondary`
* `--color-text-primary`
* `--color-text-secondary`
* `--color-accent`
* `--color-border`
* `--color-selection-background`
* `--color-selection-text`
* `--color-link`
* `--color-link-hover`

**Typography Tokens**:

* `--font-family-base`
* `--font-size-base`
* `--font-size-heading-1`
* `--font-size-heading-2`
* `--font-size-heading-3`
* `--line-height-base`

**Spacing Tokens**:

* `--spacing-xs`, `--spacing-sm`, `--spacing-md`, `--spacing-lg`, `--spacing-xl`

=== 10.3 Default Themes

**Light Theme**: Traditional light background, dark text

**Sepia Theme**: Warm, paper-like appearance for reading

**Dark Theme**: Dark background, light text

All themes stored as `.qss` files with token definitions.

=== 10.4 Custom Theme Support

* User-defined themes via stylesheet editor or theme file import
* Theme files stored in user config directory
* Theme validation (WCAG AA compliance checking)
* Theme export functionality

=== 10.5 Integration

* ThemeManager applies stylesheets to Qt Widgets (`QApplication::setStyleSheet`)
* Theme tokens injected into Qt WebEngine content via CSS
* Theme preferences persisted via QSettings
* Runtime theme switching without application restart

== 11. Typography (FR-11)

=== 11.1 Goal

Ensure all rendered content is readable, consistent, and theme-aware in the desktop viewer and printable output.

=== 11.2 Scope

* Typography preset applied to article HTML at render time.
* User may adjust base font size; presets remain consistent.

=== 11.3 Preset (viewer: sans serif)

* Font family: `Inter, system-ui, Helvetica, Arial, sans-serif`
* Base font size: *13pt*
* Line height: *1.45*
* Heading scale:
  * H1: 2.0×
  * H2: 1.6×
  * H3: 1.3×
* WCAG AA contrast must be maintained.

=== 11.4 Preset (printing: serif)

* Font family: `Junicode, Georgia, serif`
* Print uses same ratios but serif type.
* Page margins standardized for readability.

=== 11.5 Behavior

1. User selects typography settings.
2. Viewer applies typography tokens to content container (via Qt WebEngine CSS injection).
3. Typography never alters article source data.

== 12. Bibliography (FR-12)

=== 12.1 Goal

Provide generated bibliography from metadata for any article or project-wide listing.

=== 12.2 Ordering Rules

**APA:**

1. By creator last name (ascending)
2. Year (descending)
3. Title (ignore "A", "An", "The")

**CMS:**

1. Creator last name (ascending)
2. Title (alphabetical, ignore articles)
3. Year (ascending)

=== 12.3 Formatting Rules

* APA: `Lastname, Firstname. (Year). Title. Publication.`
* CMS: `Lastname, Firstname. Title. Publication, Year.`

=== 12.4 Behavior

* Viewer requests bibliography data from cartridge.
* Bibliography formatting service returns formatted text block (C++ implementation).
* Never stored, always generated.

== 13. Change Log (Newest First)

[cols="1,1,1,3"]
|===
|Version |Date |Author |Summary

|1.2
|2025-11-11
|System
|Updated for Qt 6 migration: Replaced Avalonia/CEF with Qt Widgets/WebEngine, converted all C# models to C++, updated communication to QWebChannel, added ThemeManager section (10), updated test harnesses to Qt Test.

|1.1
|2025-11-02
|System
|Added §9 Library & Manifest Management; clarified multi-cartridge design and optional cartridgeId/volume fields.

|1.0-draft
|2025-11-02
|System
|Initial detailed design covering core architecture, models, storage, and tests.
|===
